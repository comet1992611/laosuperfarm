<?xml version="1.0" encoding="UTF-8"?>
<aggregators xmlns="http://www.ekylibre.org/XML/2013/aggregators">
  <aggregator name="animal_husbandry_register" version="0.0" category="animal_farming">
    <parameters>
      <parameter name="campaigns" type="record-list" of="campaign" default="current"/>
      <parameter name="started_on" type="date" default="2013-01-01"/>
      <parameter name="stopped_on" type="date" default="2013-12-31"/>
    </parameters>
    <section name="animal_husbandry_register">
      <section name="enterprise">
        <variable name="company" value="Entity.of_company"/>
        <property name="entity_name" value="company.full_name"/>
        <property name="address" if="company.default_mail_address" value="company.default_mail_address.coordinate"/>
        <property name="ede_cattling_number" if="Identifier.find_by_nature(:cattling_number)" value="Identifier.find_by_nature(:cattling_number).value" />
        <property name="ede_owner_number" if="Identifier.find_by_nature(:husbandry_owner_number)" value="Identifier.find_by_nature(:husbandry_owner_number).value" />
      </section>
      <sections for="campaign" in="campaigns">
        <property name="name" of="campaign"/>
        <section name="plan">
          <variable name="animal_building_division" value="ProductNature.find_by(reference_name: :animal_building_division)"/>
          <property name="plan_svg" value="BuildingDivision.of_nature(animal_building_division).shape_svg(srid: 2154)" type="svg" level="api"/>
          <sections for="building_division" in="BuildingDivision.of_nature(animal_building_division)" of-type="record">
            <title name="name" of="building_division"/>
            <property name="work_number" of="building_division"/>
            <property name="area" value="building_division.net_surface_area" type="measure"/>
            <property name="area_in_square_meter" value="building_division.net_surface_area.in(:square_meter)" type="measure" level="api"/>
            <property name="id" of="building_division" level="api"/>
            <property name="shape_svg" value="building_division.shape_svg(srid: 2154)" type="svg" level="api"/>
          </sections>
        </section>
        <section name="animal_productions">
          <variable name="animal_activities" value="Activity.of_families(:animal_farming)"/>
          <sections for="production" in="ActivityProduction.of_activities(animal_activities).of_campaign(campaign)" of-type="record">
            <title name="name" of="production"/>
            <property name="started_on" of="production" type="datetime"/>
            <property name="stopped_on" of="production" type="datetime"/>
            <variable name="animal_ids" value="Product.where(activity_production: production).pluck(:id)"/>
            <sections for="animal" in="Animal.where(id: animal_ids)" of-type="record">
              <title name="name" of="animal"/>
              <property name="born_at" of="animal" if="animal.born_at" type="datetime"/>
              <property name="dead_at" of="animal" if="animal.dead_at" type="datetime"/>
              <property name="work_number" of="animal"/>
              <property name="sex" of="animal"/>
              <property name="variety" of="animal"/>
              <property name="identification_number" of="animal"/>
              <matrix name="animal_localizations" for="localization" in="animal.localizations">
                <cell name="id" of="localization" level="api"/>
                <cell name="container_name" if="localization.container" value="localization.container.name"/>
                <!--
                    <cell name="arrival_cause" of="localization"/>
                    <cell name="departure_cause" of="localization"/>
                -->
                <cell name="started_at" of="localization" if="localization.started_at" type="datetime"/>
                <cell name="stopped_at" of="localization" if="localization.stopped_at" type="datetime"/>
              </matrix>
              <matrix name="animal_treatments" for="intervention" in="Intervention.real.of_category(:animal_treating).with_generic_cast('target', animal)">
                <cell name="id" of="intervention" level="api"/>
                <section name="prescription" of="intervention.prescription">
                  <property name="id" level="api"/>
                  <title name="reference_number"/>
                  <property name="name"/>
                </section>
                <matrix name="inputs" for="input" in="intervention.inputs">
                  <variable name="meat_withdrawal_period" value="input.product.meat_withdrawal_period"/>
                  <variable name="milk_withdrawal_period" value="input.product.milk_withdrawal_period"/>
                  <cell name="id" of="input" level="api"/>
                  <within of="input.product">
                    <cell name="name"/>
                    <cell name="variety" level="api"/>
                  </within>
                  <cell name="quantity" value="input.quantity.l" type="measure" />
                  <cell name="unit_name" value="input.product.unit_name"/>
                  <matrix name="withdrawal_periods">
                    <cell name="meat_withdrawal_period" value="meat_withdrawal_period" type="measure"/>
                    <cell name="milk_withdrawal_period" value="milk_withdrawal_period" type="measure"/>
                  </matrix>
                  <matrix name="sale_dates">
                    <cell name="meat_saleable_on" value="(intervention.stopped_at + meat_withdrawal_period.to_d.send(meat_withdrawal_period.unit)).to_time" type="datetime"/>
                    <cell name="milk_saleable_on" value="(intervention.stopped_at + milk_withdrawal_period.to_d.send(milk_withdrawal_period.unit)).to_time" type="datetime"/>
                  </matrix>
                </matrix>
              </matrix>
            </sections>
          </sections>
        </section>
      </sections>
    </section>
  </aggregator>
</aggregators>
